<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Scanning MS Office documents using the MS Anti-virus API</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
<meta http-equiv="Content-Language" content="en" />
<meta name="description" content="Scanning MS Office documents using the MS Anti-virus API" />
<meta name="keywords" content="programming, Delphi, hints, tips, hints and tips" />
<meta name="copyright" content="Copyright (c) 2002-2020 Peter D Johnson" />
<meta name="robots" content="INDEX,FOLLOW" />
<link rel="canonical" href="http://delphidabbler.com/tips/126" />
<link rel="stylesheet" href="/css/main.css" />
<link rel="stylesheet" href="/css/main-multicol-scr.css" media="screen" />
<link rel="stylesheet" href="/css/main-2col-scr.css" media="screen" />
<script type="text/javascript" src="/js/core.js"></script>
<script type="text/javascript" src="/js/offsite-win.js"></script>
<link rel="stylesheet" href="/css/tips.css" />
<script type="text/javascript" src="/js/popup-win.js"></script>
<script type="text/javascript" src="/js/show-hide.js"></script>
<link rel="alternate" href="/feeds/site-news-feed?id=tips" type="application/rss+xml" title="DelphiDabbler.com Tips News" />
<link rel="stylesheet" href="/css/source.css" />
<link rel="stylesheet" href="/css/js-detect.css" />
<script type="text/javascript" src="/js/js-detect.js"></script>
<script type="text/javascript">
  function showDemo(linkId, demoId) {
    showHide(linkId, demoId, 'Show demo code', 'Hide demo code');
  }
</script>
<!-- Begin Cookie Consent plugin by Silktide - http://silktide.com/cookieconsent -->
<script type="text/javascript">
    window.cookieconsent_options = {"message":"This site uses cookies to deliver its services, to enable targeted advertising and to support various social media buttons, and to analyse traffic. By using this site, you agree to its use of cookies.","dismiss":"Got it!","learnMore":"More info","link":"http://delphidabbler.com/subsid/cookies","theme":"dark-top"};
</script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/1.0.9/cookieconsent.min.js"></script>
<!-- End Cookie Consent plugin -->
</head>
<body>
<!-- Facebook script -->
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_GB/all.js#xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<div id="wrapper">
<div id="header">
<div class="hide-from-css">
<h1>DelphiDabbler.com</h1>
<p>Open source software, Delphi components, Tutorials &amp; more.</p>
</div> <!-- .hide-from-css -->
<div id="header-right">
<div id="quicklink" style="padding-right:4px;">
&raquo; <a href="/sitemap">Sitemap</a></div>
</div>
</div> <!-- #header -->
<div class="noprint" style="padding: 0 .5em .5em .5em; margin: .5em; background-color: #fcc;">
  <h2 class="smallcaps centre-align">
    &laquo;&laquo; Site Rescued &raquo;&raquo;
  </h2>
  <p class="highlight">
    While the site is still going to move from its current host, a new site will now take its place. <strong><a href="https://delphidabbler.blogspot.com/2020/03/delphidabblercom-is-no-longer-closing.html">More Info</a></strong>.
  </p>
  <p>
    The new site may have less content, but the core will now remain. And it will now play nicely with phones! Keep an eye on the <a href="https://delphidabbler.blogspot.com/">DelphiDabbler Blog</a> for news.
  </p>
</div>
<div id="navigation">
<hr class="hide-from-css" />
<h2 class="hide-from-css">Navigation</h2>
<ul>
<li><a href="/index">Home&nbsp;Page</a></li>
<li><a href="/programs">Programs</a></li>
<li><a href="/codelib">Delphi&nbsp;Library</a></li>
<li><a href="/snips-n-tips">Snippets&nbsp;&amp;&nbsp;Tips</a>
<ul>
<li class="sub-item"><a href="http://snippets.delphidabbler.com/" class="offsite-no-glyph">Code Snippets (Take 2)</a></li>
<li class="sub-item"><a href="/tips" class="selected ">Delphi&nbsp;Tips</a></li>
<li class="sub-item"><a href="http://swag.delphidabbler.com/" class="offsite-no-glyph">SWAG&nbsp;Archive</a></li>
</ul>
</li>
<li><a href="/articles">Articles</a></li>
<li><a href="http://wiki.delphidabbler.com/" class="offsite-no-glyph">Documentation</a></li>
<li><a href="/blog">Blog</a></li>
<li><a href="/news">News</a></li>
<li><a href="/contact">Contact</a></li>
<li><a href="/background">About</a></li>
</ul>
</div> <!-- #navigation -->
<div id="main">
<div id="content">
<span class="help noprint">&raquo <a href="/help/tips-help.html" class="js-popup">Help</a></span>
<h1>
	Scanning MS Office documents using the MS Anti-virus API
</h1>

<div class="noprint">
<!-- style in following div and non-breaking spaces are a work around for a
     rendering bug in IE7 that sometimes hides preceeding h1 section if nothing
     is printed before this show_ads.js code is run.
     Tested and runs OK on Safari, Opera, Firefox, Chrome, but then, so did the
     original code! -->
<div class="centre-align" style="font-size:1pt;">&nbsp;
<script type="text/javascript"><!--
google_ad_client = "ca-pub-0907703677935617";
/* 468x60, created 11/04/09 */
google_ad_slot = "8060165044";
google_ad_width = 468;
google_ad_height = 60;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
&nbsp;
</div>
</div>
<p>
  The Microsoft Antivirus API enables software developers to develop
  applications that scan Microsoft Office documents before opening them. The
  Antivirus API also supports scanning Microsoft IE code downloads, such as
  ActiveX controls.
</p>

<p>
  The primary purpose of this API is to give a software developers the ability
  to design and implement antivirus software that can be used by all
  applications. The antivirus component is a standard ActiveX component you
  register as an in-process server that supports the MSOfficeAntiVirus
  component category:<br /><code>(CATID_MSOfficeAntiVirus:
  TGUID = '{56FFCC30-D398-11d0-B2AE-00A0C908FA49}')</code>.
</p>

<p>
   IE and MS Office implement the antivirus component as follows:
</p>

<ol>
  <li>
     Obtain the list of all the installed antivirus components registered as
     supporting the <em>MSOfficeAntiVirus</em> component category.
   </li>
   <li>
     Launch the installed components.
   </li>
   <li>
     Query for the <var>IOfficeAntiVirus</var> interface.
   </li>
   <li>
     Call the <var>IOfficeAntiVirus.Scan</var> method to obtain all the
     installed components.
   </li>
   <li>
     Continue to open the file after the virus scan, regardless of the
     <var>HRESULT</var> value. The antivirus software warns a user if a file
     has a known virus but opens the file after the warning. It is up to the
     user to take action concerning the warning.
   </li>
</ol>

<div class="frame">
<!-- Highlighted Pascal code generated by DelphiDabbler PasH -->
<pre class="pas-source"><span class="pas-kwd">unit</span><span class="pas-space"> </span><span class="pas-ident">msoav</span><span class="pas-sym">;</span>

<span class="pas-kwd">interface</span>

<span class="pas-kwd">uses</span><span class="pas-space"> </span><span class="pas-ident">Windows</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">SysUtils</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">ActiveX</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">ComObj</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">Classes</span><span class="pas-sym">;</span>

<span class="pas-kwd">const</span>
<span class="pas-ident">IID_IOfficeAntiVirus</span><span class="pas-space"> </span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">TGUID</span><span class="pas-space"> </span><span class="pas-sym">=</span><span class="pas-space">    </span><span class="pas-str">'{56FFCC30-D398-11d0-B2AE-00A0C908FA49}'</span><span class="pas-sym">;</span>
<span class="pas-ident">CATID_MSOfficeAntiVirus</span><span class="pas-space"> </span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">TGUID</span><span class="pas-space"> </span><span class="pas-sym">=</span><span class="pas-space"> </span><span class="pas-str">'{56FFCC30-D398-11d0-B2AE-00A0C908FA49}'</span><span class="pas-sym">;</span>

<span class="pas-kwd">type</span>

<span class="pas-space">  </span><span class="pas-ident">TInfoStruct</span><span class="pas-space"> </span><span class="pas-sym">=</span><span class="pas-space"> </span><span class="pas-kwd">record</span>
<span class="pas-space">    </span><span class="pas-ident">fIsFile</span><span class="pas-space"> </span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">boolean</span><span class="pas-sym">;</span>
<span class="pas-space">    </span><span class="pas-ident">fIsReadOnly</span><span class="pas-space"> </span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">boolean</span><span class="pas-sym">;</span>
<span class="pas-space">    </span><span class="pas-ident">fIsInstalled</span><span class="pas-space"> </span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">boolean</span><span class="pas-sym">;</span>
<span class="pas-space">    </span><span class="pas-ident">fIsHTTPDownload</span><span class="pas-space"> </span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">boolean</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-space">  </span><span class="pas-comment">{Contains information about the file to be scanned:</span>
<span class="pas-comment">  * cbSize      - Integer value that specifies the size of an MSOAVINFO</span>
<span class="pas-comment">  *               structure.</span>
<span class="pas-comment">  * hWnd        - Handle to the parent window of the Microsoft&#174; Office 2000</span>
<span class="pas-comment">  *               application.</span>
<span class="pas-comment">  * pwzFullPath - Address of a wide character string that contains the full</span>
<span class="pas-comment">  *               path of the file about to be opened.</span>
<span class="pas-comment">  * lpStg       - Address of the OLE storage location of the file about to</span>
<span class="pas-comment">  *               be opened.</span>
<span class="pas-comment">  * pwzHostName - Address of a wide character string that contains the host</span>
<span class="pas-comment">  *               application name for the antivirus scanner user interface.</span>
<span class="pas-comment">  * pwzOrigURL  - Address of a wide character string that contains the URL</span>
<span class="pas-comment">  *               of the origin of a downloaded file.}</span>
<span class="pas-space">  </span><span class="pas-ident">TMsoavinfo</span><span class="pas-space"> </span><span class="pas-sym">=</span><span class="pas-space"> </span><span class="pas-kwd">record</span>
<span class="pas-space">    </span><span class="pas-ident">cbSize</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">integer</span><span class="pas-sym">;</span>
<span class="pas-space">    </span><span class="pas-ident">info</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">ULONG</span><span class="pas-sym">;</span>
<span class="pas-space">    </span><span class="pas-ident">wnd</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">HWND</span><span class="pas-sym">;</span>
<span class="pas-space">    </span><span class="pas-ident">FullPath</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">Pointer</span><span class="pas-sym">;</span>
<span class="pas-space">    </span><span class="pas-ident">pwzHostName</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">PWChar</span><span class="pas-sym">;</span>
<span class="pas-space">    </span><span class="pas-ident">pwzOrigURL</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">PWChar</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-space">  </span><span class="pas-comment">{This is the interface an antivirus scanner uses to interact with a host</span>
<span class="pas-comment">  application}</span>
<span class="pas-space">  </span><span class="pas-ident">IOfficeAntiVirus</span><span class="pas-space"> </span><span class="pas-sym">=</span><span class="pas-space"> </span><span class="pas-kwd">interface</span><span class="pas-sym">(</span><span class="pas-ident">IUnknown</span><span class="pas-sym">)</span>
<span class="pas-space">  </span><span class="pas-sym">[</span><span class="pas-str">'{56FFCC30-D398-11d0-B2AE-00A0C908FA49}'</span><span class="pas-sym">]</span>
<span class="pas-space">    </span><span class="pas-kwd">function</span><span class="pas-space"> </span><span class="pas-ident">Scan</span><span class="pas-sym">(</span><span class="pas-ident">pmsoavinfo</span><span class="pas-space"> </span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">PChar</span><span class="pas-sym">)</span><span class="pas-space"> </span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">HResult</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-kwd">stdcall</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-kwd">function</span><span class="pas-space"> </span><span class="pas-ident">TestBit</span><span class="pas-sym">(</span><span class="pas-kwd">const</span><span class="pas-space"> </span><span class="pas-ident">Value</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">Cardinal</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-kwd">const</span><span class="pas-space"> </span><span class="pas-ident">Bit</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">byte</span><span class="pas-sym">)</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">Boolean</span><span class="pas-sym">;</span>
<span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">GetRegisteredAntiviruses</span><span class="pas-sym">(</span><span class="pas-ident">ProgIDs</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">TStrings</span><span class="pas-sym">)</span><span class="pas-sym">;</span>

<span class="pas-kwd">implementation</span>

<span class="pas-kwd">function</span><span class="pas-space"> </span><span class="pas-ident">TestBit</span><span class="pas-sym">(</span><span class="pas-kwd">const</span><span class="pas-space"> </span><span class="pas-ident">Value</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">Cardinal</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-kwd">const</span><span class="pas-space"> </span><span class="pas-ident">Bit</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">byte</span><span class="pas-sym">)</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">Boolean</span><span class="pas-sym">;</span>
<span class="pas-kwd">begin</span>
<span class="pas-space">  </span><span class="pas-ident">Result</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space"> </span><span class="pas-sym">(</span><span class="pas-ident">Value</span><span class="pas-space"> </span><span class="pas-kwd">and</span><span class="pas-space"> </span><span class="pas-sym">(</span><span class="pas-num">1</span><span class="pas-space"> </span><span class="pas-kwd">shl</span><span class="pas-space"> </span><span class="pas-sym">(</span><span class="pas-ident">Bit</span><span class="pas-space"> </span><span class="pas-kwd">mod</span><span class="pas-space"> </span><span class="pas-num">32</span><span class="pas-sym">)</span><span class="pas-sym">)</span><span class="pas-sym">)</span><span class="pas-space"> </span><span class="pas-sym">&lt;&gt;</span><span class="pas-space"> </span><span class="pas-num">0</span><span class="pas-sym">;</span>
<span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">GetRegisteredAntiviruses</span><span class="pas-sym">(</span><span class="pas-ident">ProgIDs</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">TStrings</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-kwd">var</span>
<span class="pas-space">  </span><span class="pas-ident">CatInformation</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">ICatInformation</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-ident">Enum</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">IEnumGUID</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-ident">CLSID</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">TGUID</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-ident">nFetched</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">Cardinal</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-ident">CatId</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">TGUID</span><span class="pas-sym">;</span>
<span class="pas-kwd">begin</span>
<span class="pas-space">  </span><span class="pas-ident">CatInformation</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space"> </span><span class="pas-ident">CreateComObject</span><span class="pas-sym">(</span><span class="pas-ident">CLSID_StdComponentCategoryMgr</span><span class="pas-sym">)</span>
<span class="pas-space">    </span><span class="pas-kwd">as</span><span class="pas-space"> </span><span class="pas-ident">ICatInformation</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-ident">CatId</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space"> </span><span class="pas-ident">CATID_MSOfficeAntiVirus</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-ident">OleCheck</span><span class="pas-sym">(</span><span class="pas-ident">CatInformation</span><span class="pas-sym">.</span><span class="pas-ident">EnumClassesOfCategories</span><span class="pas-sym">(</span><span class="pas-num">1</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-sym">@</span><span class="pas-ident">CatId</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-num">0</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-kwd">nil</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">Enum</span><span class="pas-sym">)</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-ident">ProgIDs</span><span class="pas-sym">.</span><span class="pas-ident">BeginUpdate</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">try</span>
<span class="pas-space">    </span><span class="pas-ident">ProgIDs</span><span class="pas-sym">.</span><span class="pas-ident">Clear</span><span class="pas-sym">;</span>
<span class="pas-space">    </span><span class="pas-kwd">while</span><span class="pas-space"> </span><span class="pas-sym">(</span><span class="pas-ident">Enum</span><span class="pas-sym">.</span><span class="pas-ident">Next</span><span class="pas-sym">(</span><span class="pas-num">1</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">CLSID</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">nFetched</span><span class="pas-sym">)</span><span class="pas-space"> </span><span class="pas-sym">=</span><span class="pas-space"> </span><span class="pas-ident">S_OK</span><span class="pas-sym">)</span><span class="pas-space"> </span><span class="pas-kwd">do</span><span class="pas-space"> </span><span class="pas-kwd">begin</span>
<span class="pas-space">      </span><span class="pas-ident">ProgIDs</span><span class="pas-sym">.</span><span class="pas-ident">Add</span><span class="pas-sym">(</span><span class="pas-ident">GuidToString</span><span class="pas-sym">(</span><span class="pas-ident">clsid</span><span class="pas-sym">)</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">    </span><span class="pas-kwd">end</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">finally</span>
<span class="pas-space">    </span><span class="pas-ident">ProgIDs</span><span class="pas-sym">.</span><span class="pas-ident">EndUpdate</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">end</span><span class="pas-sym">;</span>
<span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-kwd">end</span><span class="pas-sym">.</span></pre>
</div>

<p>
  Now I will show a small example how to use the <var>IOfficeAntiVirus</var>
  interface to implement own antivirus program for Microsoft Office.
</p>

<div class="frame">
<!-- Highlighted Pascal code generated by DelphiDabbler PasH -->
<pre class="pas-source"><span class="pas-kwd">library</span><span class="pas-space"> </span><span class="pas-ident">msoavtest</span><span class="pas-sym">;</span>

<span class="pas-kwd">uses</span>
<span class="pas-space">  </span><span class="pas-ident">ComServ</span><span class="pas-sym">,</span>
<span class="pas-space">  </span><span class="pas-ident">msoav</span><span class="pas-sym">,</span>
<span class="pas-space">  </span><span class="pas-ident">umsoavtest</span><span class="pas-sym">;</span>

<span class="pas-kwd">exports</span>
<span class="pas-space">  </span><span class="pas-ident">DllGetClassObject</span><span class="pas-sym">,</span>
<span class="pas-space">  </span><span class="pas-ident">DllCanUnloadNow</span><span class="pas-sym">,</span>
<span class="pas-space">  </span><span class="pas-ident">DllRegisterServer</span><span class="pas-sym">,</span>
<span class="pas-space">  </span><span class="pas-ident">DllUnregisterServer</span><span class="pas-sym">;</span>

<span class="pas-kwd">begin</span>
<span class="pas-kwd">end</span><span class="pas-sym">.</span></pre>
</div>

<div class="frame">
<!-- Highlighted Pascal code generated by DelphiDabbler PasH -->
<pre class="pas-source"><span class="pas-kwd">unit</span><span class="pas-space"> </span><span class="pas-ident">umsoavtest</span><span class="pas-sym">;</span>

<span class="pas-kwd">interface</span>

<span class="pas-kwd">uses</span>
<span class="pas-space">  </span><span class="pas-ident">Windows</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">ActiveX</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">ComObj</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">ShlObj</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">Dialogs</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">msoav</span><span class="pas-sym">;</span>

<span class="pas-kwd">type</span>
<span class="pas-space">  </span><span class="pas-ident">TMSOTest</span><span class="pas-space"> </span><span class="pas-sym">=</span><span class="pas-space"> </span><span class="pas-kwd">class</span><span class="pas-sym">(</span><span class="pas-ident">TComObject</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">IOfficeAntiVirus</span><span class="pas-sym">)</span>
<span class="pas-space">  </span><span class="pas-kwd">protected</span>
<span class="pas-space">   </span><span class="pas-kwd">function</span><span class="pas-space"> </span><span class="pas-ident">Scan</span><span class="pas-sym">(</span><span class="pas-ident">pmsoavinfo</span><span class="pas-space"> </span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">PChar</span><span class="pas-sym">)</span><span class="pas-space"> </span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">HResult</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-kwd">stdcall</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-kwd">const</span>
<span class="pas-space">  </span><span class="pas-ident">Class_MsoTest</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">TGUID</span><span class="pas-space"> </span><span class="pas-sym">=</span><span class="pas-space"> </span><span class="pas-str">'{F56BE781-C8BE-11D7-8601-00E0184D1E9D}'</span><span class="pas-sym">;</span>

<span class="pas-kwd">implementation</span>

<span class="pas-kwd">uses</span><span class="pas-space"> </span><span class="pas-ident">ComServ</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">SysUtils</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">ShellApi</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">Registry</span><span class="pas-sym">;</span>

<span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">UpdateCat</span><span class="pas-sym">(</span><span class="pas-kwd">Register</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">Boolean</span><span class="pas-sym">;</span><span class="pas-space">  </span><span class="pas-kwd">const</span><span class="pas-space"> </span><span class="pas-ident">ClassID</span><span class="pas-sym">:</span><span class="pas-space">  </span><span class="pas-kwd">string</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-kwd">const</span>
<span class="pas-space">  </span><span class="pas-ident">SCatImplBaseKey</span><span class="pas-space"> </span><span class="pas-sym">=</span><span class="pas-space"> </span><span class="pas-str">'CLSID\%s\Implemented Categories'</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-ident">SCatImplKey</span><span class="pas-space"> </span><span class="pas-sym">=</span><span class="pas-space"> </span><span class="pas-ident">SCatImplBaseKey</span><span class="pas-space"> </span><span class="pas-sym">+</span><span class="pas-space"> </span><span class="pas-str">'\%s'</span><span class="pas-sym">;</span>
<span class="pas-kwd">var</span>
<span class="pas-space">  </span><span class="pas-ident">CatReg</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">ICatRegister</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-ident">Rslt</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">HResult</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-ident">CatInfo</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">TCATEGORYINFO</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-ident">Description</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-kwd">string</span><span class="pas-sym">;</span>
<span class="pas-kwd">begin</span>
<span class="pas-space">  </span><span class="pas-ident">Rslt</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space"> </span><span class="pas-ident">CoCreateInstance</span><span class="pas-sym">(</span><span class="pas-ident">CLSID_StdComponentCategoryMgr</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-kwd">nil</span><span class="pas-sym">,</span>
<span class="pas-space">    </span><span class="pas-ident">CLSCTX_INPROC_SERVER</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">ICatRegister</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">CatReg</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">if</span><span class="pas-space"> </span><span class="pas-ident">Succeeded</span><span class="pas-sym">(</span><span class="pas-ident">Rslt</span><span class="pas-sym">)</span><span class="pas-space"> </span><span class="pas-kwd">then</span>
<span class="pas-space">  </span><span class="pas-kwd">begin</span>
<span class="pas-space">    </span><span class="pas-kwd">if</span><span class="pas-space"> </span><span class="pas-kwd">Register</span><span class="pas-space"> </span><span class="pas-kwd">then</span>
<span class="pas-space">    </span><span class="pas-kwd">begin</span>
<span class="pas-space">      </span><span class="pas-ident">CatInfo</span><span class="pas-sym">.</span><span class="pas-ident">catid</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space"> </span><span class="pas-ident">CATID_MSOfficeAntiVirus</span><span class="pas-sym">;</span>
<span class="pas-space">      </span><span class="pas-ident">CatInfo</span><span class="pas-sym">.</span><span class="pas-ident">lcid</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space"> </span><span class="pas-hex">$0409</span><span class="pas-sym">;</span>
<span class="pas-space">      </span><span class="pas-ident">StringToWideChar</span><span class="pas-sym">(</span><span class="pas-str">''</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">CatInfo</span><span class="pas-sym">.</span><span class="pas-ident">szDescription</span><span class="pas-sym">,</span>
<span class="pas-space">        </span><span class="pas-ident">Length</span><span class="pas-sym">(</span><span class="pas-str">''</span><span class="pas-sym">)</span><span class="pas-space"> </span><span class="pas-sym">+</span><span class="pas-space"> </span><span class="pas-num">1</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">      </span><span class="pas-ident">OleCheck</span><span class="pas-sym">(</span><span class="pas-ident">CatReg</span><span class="pas-sym">.</span><span class="pas-ident">RegisterCategories</span><span class="pas-sym">(</span><span class="pas-num">1</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-sym">@</span><span class="pas-ident">CatInfo</span><span class="pas-sym">)</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">      </span><span class="pas-ident">OleCheck</span><span class="pas-sym">(</span>
<span class="pas-space">        </span><span class="pas-ident">CatReg</span><span class="pas-sym">.</span><span class="pas-ident">RegisterClassImplCategories</span><span class="pas-sym">(</span>
<span class="pas-space">          </span><span class="pas-ident">StringToGUID</span><span class="pas-sym">(</span><span class="pas-ident">ClassID</span><span class="pas-sym">)</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-num">1</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-sym">@</span><span class="pas-ident">CATID_MSOfficeAntiVirus</span>
<span class="pas-space">        </span><span class="pas-sym">)</span>
<span class="pas-space">      </span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">    </span><span class="pas-kwd">end</span>
<span class="pas-space">    </span><span class="pas-kwd">else</span>
<span class="pas-space">    </span><span class="pas-kwd">begin</span>
<span class="pas-space">      </span><span class="pas-ident">OleCheck</span><span class="pas-sym">(</span>
<span class="pas-space">        </span><span class="pas-ident">CatReg</span><span class="pas-sym">.</span><span class="pas-ident">UnRegisterClassImplCategories</span><span class="pas-sym">(</span>
<span class="pas-space">          </span><span class="pas-ident">StringToGUID</span><span class="pas-sym">(</span><span class="pas-ident">ClassID</span><span class="pas-sym">)</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-num">1</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-sym">@</span><span class="pas-ident">CATID_MSOfficeAntiVirus</span>
<span class="pas-space">        </span><span class="pas-sym">)</span>
<span class="pas-space">      </span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">      </span><span class="pas-ident">DeleteRegKey</span><span class="pas-sym">(</span><span class="pas-ident">Format</span><span class="pas-sym">(</span><span class="pas-ident">SCatImplBaseKey</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-sym">[</span><span class="pas-ident">ClassID</span><span class="pas-sym">]</span><span class="pas-sym">)</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">    </span><span class="pas-kwd">end</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">end</span>
<span class="pas-space">  </span><span class="pas-kwd">else</span>
<span class="pas-space">  </span><span class="pas-kwd">begin</span>
<span class="pas-space">    </span><span class="pas-kwd">if</span><span class="pas-space"> </span><span class="pas-kwd">Register</span><span class="pas-space"> </span><span class="pas-kwd">then</span>
<span class="pas-space">    </span><span class="pas-kwd">begin</span>
<span class="pas-space">      </span><span class="pas-ident">CreateRegKey</span><span class="pas-sym">(</span>
<span class="pas-space">        </span><span class="pas-str">'Component Categories\'</span><span class="pas-space"> </span><span class="pas-sym">+</span><span class="pas-space"> </span><span class="pas-ident">GUIDToString</span><span class="pas-sym">(</span><span class="pas-ident">CATID_MSOfficeAntiVirus</span><span class="pas-sym">)</span><span class="pas-sym">,</span>
<span class="pas-space">        </span><span class="pas-str">'409'</span><span class="pas-sym">,</span>
<span class="pas-space">        </span><span class="pas-str">''</span>
<span class="pas-space">      </span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">      </span><span class="pas-ident">CreateRegKey</span><span class="pas-sym">(</span>
<span class="pas-space">        </span><span class="pas-ident">Format</span><span class="pas-sym">(</span>
<span class="pas-space">          </span><span class="pas-ident">SCatImplKey</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-sym">[</span><span class="pas-ident">ClassID</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">GUIDToString</span><span class="pas-sym">(</span><span class="pas-ident">CATID_MSOfficeAntiVirus</span><span class="pas-sym">)</span><span class="pas-sym">]</span>
<span class="pas-space">        </span><span class="pas-sym">)</span><span class="pas-sym">,</span>
<span class="pas-space">        </span><span class="pas-str">''</span><span class="pas-sym">,</span>
<span class="pas-space">        </span><span class="pas-str">''</span>
<span class="pas-space">      </span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">    </span><span class="pas-kwd">end</span>
<span class="pas-space">    </span><span class="pas-kwd">else</span>
<span class="pas-space">    </span><span class="pas-kwd">begin</span>
<span class="pas-space">      </span><span class="pas-ident">DeleteRegKey</span><span class="pas-sym">(</span>
<span class="pas-space">        </span><span class="pas-ident">Format</span><span class="pas-sym">(</span>
<span class="pas-space">          </span><span class="pas-ident">SCatImplKey</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-sym">[</span><span class="pas-ident">ClassID</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">GUIDToString</span><span class="pas-sym">(</span><span class="pas-ident">CATID_MSOfficeAntiVirus</span><span class="pas-sym">)</span><span class="pas-sym">]</span>
<span class="pas-space">        </span><span class="pas-sym">)</span>
<span class="pas-space">      </span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">      </span><span class="pas-ident">DeleteRegKey</span><span class="pas-sym">(</span><span class="pas-ident">Format</span><span class="pas-sym">(</span><span class="pas-ident">SCatImplBaseKey</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-sym">[</span><span class="pas-ident">ClassID</span><span class="pas-sym">]</span><span class="pas-sym">)</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">    </span><span class="pas-kwd">end</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">end</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">if</span><span class="pas-space"> </span><span class="pas-kwd">Register</span><span class="pas-space"> </span><span class="pas-kwd">then</span>
<span class="pas-space">  </span><span class="pas-kwd">begin</span>
<span class="pas-space">    </span><span class="pas-ident">Description</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space"> </span><span class="pas-ident">GetRegStringValue</span><span class="pas-sym">(</span><span class="pas-str">'CLSID\'</span><span class="pas-space"> </span><span class="pas-sym">+</span><span class="pas-space"> </span><span class="pas-ident">ClassID</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-str">''</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">    </span><span class="pas-ident">CreateRegKey</span><span class="pas-sym">(</span><span class="pas-str">'AppID\'</span><span class="pas-space"> </span><span class="pas-sym">+</span><span class="pas-space"> </span><span class="pas-ident">ClassID</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-str">''</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">Description</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">    </span><span class="pas-ident">CreateRegKey</span><span class="pas-sym">(</span><span class="pas-str">'CLSID\'</span><span class="pas-space"> </span><span class="pas-sym">+</span><span class="pas-space"> </span><span class="pas-ident">ClassID</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-str">'AppID'</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">ClassID</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">end</span>
<span class="pas-space">  </span><span class="pas-kwd">else</span>
<span class="pas-space">    </span><span class="pas-ident">DeleteRegKey</span><span class="pas-sym">(</span><span class="pas-str">'AppID\'</span><span class="pas-space"> </span><span class="pas-sym">+</span><span class="pas-space"> </span><span class="pas-ident">ClassID</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-comment">{ TMSOTest }</span>

<span class="pas-kwd">function</span><span class="pas-space"> </span><span class="pas-ident">TMSOTest</span><span class="pas-sym">.</span><span class="pas-ident">Scan</span><span class="pas-sym">(</span><span class="pas-ident">pmsoavinfo</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">PChar</span><span class="pas-sym">)</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">HResult</span><span class="pas-sym">;</span>
<span class="pas-kwd">var</span>
<span class="pas-ident">Info</span><span class="pas-space">   </span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">TMsoavinfo</span><span class="pas-sym">;</span>
<span class="pas-ident">Struct</span><span class="pas-space"> </span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">TInfoStruct</span><span class="pas-sym">;</span>
<span class="pas-ident">p</span><span class="pas-space"> </span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">pointer</span><span class="pas-sym">;</span>
<span class="pas-kwd">begin</span>
<span class="pas-space">  </span><span class="pas-ident">p</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space"> </span><span class="pas-ident">pointer</span><span class="pas-sym">(</span><span class="pas-ident">pmsoavinfo</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">if</span><span class="pas-space"> </span><span class="pas-kwd">not</span><span class="pas-space"> </span><span class="pas-ident">Assigned</span><span class="pas-sym">(</span><span class="pas-ident">p</span><span class="pas-sym">)</span><span class="pas-space"> </span><span class="pas-kwd">then</span>
<span class="pas-space">   </span><span class="pas-kwd">begin</span>
<span class="pas-space">     </span><span class="pas-comment">//no information available</span>
<span class="pas-space">     </span><span class="pas-ident">Result</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space"> </span><span class="pas-ident">S_OK</span><span class="pas-sym">;</span>
<span class="pas-space">     </span><span class="pas-ident">Exit</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-space">  </span><span class="pas-ident">Move</span><span class="pas-sym">(</span><span class="pas-ident">P</span><span class="pas-sym">^</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">Info</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">SizeOf</span><span class="pas-sym">(</span><span class="pas-ident">Tmsoavinfo</span><span class="pas-sym">)</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">if</span><span class="pas-space"> </span><span class="pas-ident">Info</span><span class="pas-sym">.</span><span class="pas-ident">cbSize</span><span class="pas-space"> </span><span class="pas-sym">&lt;&gt;</span><span class="pas-space"> </span><span class="pas-ident">SizeOf</span><span class="pas-sym">(</span><span class="pas-ident">Tmsoavinfo</span><span class="pas-sym">)</span><span class="pas-space"> </span><span class="pas-kwd">then</span>
<span class="pas-space">   </span><span class="pas-kwd">begin</span>
<span class="pas-space">     </span><span class="pas-comment">//wrong size of the structure</span>
<span class="pas-space">     </span><span class="pas-ident">Result</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space"> </span><span class="pas-ident">S_OK</span><span class="pas-sym">;</span>
<span class="pas-space">     </span><span class="pas-ident">Exit</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-kwd">end</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-ident">Struct</span><span class="pas-sym">.</span><span class="pas-ident">fIsFile</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space"> </span><span class="pas-ident">TestBit</span><span class="pas-sym">(</span><span class="pas-ident">Info</span><span class="pas-sym">.</span><span class="pas-ident">Info</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-num">0</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-ident">Struct</span><span class="pas-sym">.</span><span class="pas-ident">fIsReadOnly</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space"> </span><span class="pas-ident">TestBit</span><span class="pas-sym">(</span><span class="pas-ident">Info</span><span class="pas-sym">.</span><span class="pas-ident">Info</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-num">1</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-ident">Struct</span><span class="pas-sym">.</span><span class="pas-ident">fIsInstalled</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space"> </span><span class="pas-ident">TestBit</span><span class="pas-sym">(</span><span class="pas-ident">Info</span><span class="pas-sym">.</span><span class="pas-ident">Info</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-num">2</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-ident">Struct</span><span class="pas-sym">.</span><span class="pas-ident">fIsHTTPDownload</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space">  </span><span class="pas-ident">TestBit</span><span class="pas-sym">(</span><span class="pas-ident">Info</span><span class="pas-sym">.</span><span class="pas-ident">Info</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-num">3</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">if</span><span class="pas-space"> </span><span class="pas-ident">struct</span><span class="pas-sym">.</span><span class="pas-ident">fIsFile</span><span class="pas-space"> </span><span class="pas-kwd">then</span>
<span class="pas-space">   </span><span class="pas-kwd">begin</span>
<span class="pas-space">     </span><span class="pas-ident">MessageDlg</span><span class="pas-sym">(</span><span class="pas-ident">PWChar</span><span class="pas-sym">(</span><span class="pas-ident">Info</span><span class="pas-sym">.</span><span class="pas-ident">FullPath</span><span class="pas-sym">)</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">mtWarning</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-sym">[</span><span class="pas-ident">mbOK</span><span class="pas-sym">]</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-num">0</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">   </span><span class="pas-kwd">end</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-ident">Result</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space"> </span><span class="pas-ident">S_OK</span><span class="pas-sym">;</span>
<span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-kwd">type</span>
<span class="pas-space">  </span><span class="pas-ident">TMSOAvFactory</span><span class="pas-space"> </span><span class="pas-sym">=</span><span class="pas-space"> </span><span class="pas-kwd">class</span><span class="pas-sym">(</span><span class="pas-ident">TComObjectFactory</span><span class="pas-sym">)</span>
<span class="pas-space">  </span><span class="pas-kwd">public</span>
<span class="pas-space">    </span><span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">UpdateRegistry</span><span class="pas-sym">(</span><span class="pas-kwd">Register</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">Boolean</span><span class="pas-sym">)</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-kwd">override</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">TMSOAVFactory</span><span class="pas-sym">.</span><span class="pas-ident">UpdateRegistry</span><span class="pas-sym">(</span><span class="pas-kwd">Register</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">Boolean</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-kwd">var</span>
<span class="pas-space">  </span><span class="pas-ident">ClassID</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-kwd">string</span><span class="pas-sym">;</span>
<span class="pas-kwd">begin</span>
<span class="pas-space">  </span><span class="pas-ident">ClassID</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space"> </span><span class="pas-ident">GUIDToString</span><span class="pas-sym">(</span><span class="pas-ident">Class_MsoTest</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">if</span><span class="pas-space"> </span><span class="pas-kwd">Register</span><span class="pas-space"> </span><span class="pas-kwd">then</span>
<span class="pas-space">  </span><span class="pas-kwd">begin</span>
<span class="pas-space">    </span><span class="pas-kwd">inherited</span><span class="pas-space"> </span><span class="pas-ident">UpdateRegistry</span><span class="pas-sym">(</span><span class="pas-kwd">Register</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">    </span><span class="pas-ident">UpdateCat</span><span class="pas-sym">(</span><span class="pas-ident">true</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">ClassID</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">end</span>
<span class="pas-space">  </span><span class="pas-kwd">else</span>
<span class="pas-space">  </span><span class="pas-kwd">begin</span>
<span class="pas-space">    </span><span class="pas-ident">UpdateCat</span><span class="pas-sym">(</span><span class="pas-ident">false</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">ClassID</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">    </span><span class="pas-kwd">inherited</span><span class="pas-space"> </span><span class="pas-ident">UpdateRegistry</span><span class="pas-sym">(</span><span class="pas-kwd">Register</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">end</span><span class="pas-sym">;</span>
<span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-kwd">initialization</span>
<span class="pas-space">  </span><span class="pas-ident">TComObjectFactory</span><span class="pas-sym">.</span><span class="pas-ident">Create</span><span class="pas-sym">(</span>
<span class="pas-space">    </span><span class="pas-ident">ComServer</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">TMsoTest</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">Class_MsoTest</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-str">'MsoTest'</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-str">''</span><span class="pas-sym">,</span>
<span class="pas-space">    </span><span class="pas-ident">ciMultiInstance</span><span class="pas-sym">,</span><span class="pas-space"> </span><span class="pas-ident">tmApartment</span>
<span class="pas-space">  </span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-kwd">end</span><span class="pas-sym">.</span></pre>
</div>
<table class="infotable">
  <tr>
    <th scope="row">Author:</th>
    <td>Shlomo Abuisak</td>
  </tr>
  <tr>
    <th scope="row">Contributor:</th>
    <td>Shlomo Abuisak</td>
  </tr>
  <tr>
    <th scope="row">Added:</th>
    <td>2009-11-05</td>
  </tr>
  <tr>
    <th scope="row">Last updated:</th>
    <td>
    2009-11-05</td>
  </tr>
</table>

<div class="search noprint">
<form name="tipsSearchForm" id="tipsSearchForm" method="post" action="/tips">
<input class="text" type="text" name="txtSearch" id="txtSearch" value="" size="24" maxlength="80" />
<input class="button" type="submit" name="btnSearch" id="btnSearch" value="Search" />
</form>
</div>
<ul class="tip-nav noprint">
<li><a href="/tips/1">First</a></li>
<li><span class="spacer">...</span></li>
<li><a href="/tips/122">122</a></li>
<li><a href="/tips/123">123</a></li>
<li><a href="/tips/124">124</a></li>
<li><a href="/tips/125">125</a></li>
<li><span class="current">126</span></li>
<li><a href="/tips/127">127</a></li>
<li><a href="/tips/128">128</a></li>
<li><a href="/tips/129">129</a></li>
<li><a href="/tips/130">130</a></li>
<li><span class="spacer">...</span></li>
<li><a href="/tips/234">Last</a></li>
</ul>

<p class="centre-align noprint">
  &laquo; <a href="/tips">Return to contents</a> &raquo;
</p>

</div> <!-- #content -->
</div> <!-- #main -->
<div id="footer">
<div class="hide-from-css"><hr /></div> <!-- .hide-from-css -->
<a href="/copyright">Copyright</a> &copy; Peter Johnson (<a href="/background">DelphiDabbler</a>) 2002-2020</div> <!-- #footer -->
</div> <!-- #wrapper -->
</body>
</html>
