<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<head>
<title>Prevent system sleep</title>
<meta http-equiv="Content-Language" content="en" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Prevent system sleep" />
<meta name="keywords" content="programming, Delphi, hints, tips, hints and tips" />
<meta name="copyright" content="Copyright (c) 2002-2020 Peter D Johnson" />
<meta name="robots" content="INDEX,FOLLOW" />
<link rel="stylesheet" href="../css/main.css" />
<script type="text/javascript" src="../js/core.js"></script>
<script type="text/javascript" src="../js/offsite-win.js"></script>
<link rel="stylesheet" href="../css/tips.css" />
<link rel="stylesheet" href="../css/source.css" />
</head>
<body>
<div id="wrapper">

<h1>
	Prevent system sleep
</h1>

<!-- BEGIN Redirection Note -->
<p class="redirect-note">
  If got here by following a link such as <b>http://delphidabbler.com/tips/<em>999</em></b> (where <em>999</em> is a number) then you were re-directed because the tip is not yet available on the new delphidabbler.com website. <a href="https://delphidabbler.com/tips"><b>Go back to the delphidabbler.com tips page</b></a>
</p>
<!-- END OF Redirection Note -->

<p>
  Windows detects activities such as keyboard or mouse input &ndash; after a
  long idle time the system might go to sleep mode and/or power off the
  display device.
</p>

<p>
  Here's a unit you can use to prevent the system going to sleep during
  critical operations.
</p>

<div class="frame">
<!-- Highlighted Pascal code generated by DelphiDabbler PasH -->
<pre class="pas-source"><span class="pas-kwd">unit</span><span class="pas-space"> </span><span class="pas-ident">SystemCriticalU</span><span class="pas-sym">;</span>

<span class="pas-kwd">interface</span>

<span class="pas-kwd">uses</span>
<span class="pas-space">  </span><span class="pas-ident">Windows</span><span class="pas-sym">;</span>

<span class="pas-kwd">type</span>
<span class="pas-space">  </span><span class="pas-ident">TSystemCritical</span><span class="pas-space"> </span><span class="pas-sym">=</span><span class="pas-space"> </span><span class="pas-kwd">class</span>
<span class="pas-space">  </span><span class="pas-kwd">private</span>
<span class="pas-space">    </span><span class="pas-ident">FIsCritical</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">Boolean</span><span class="pas-sym">;</span>
<span class="pas-space">    </span><span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">SetIsCritical</span><span class="pas-sym">(</span><span class="pas-kwd">const</span><span class="pas-space"> </span><span class="pas-ident">Value</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">Boolean</span><span class="pas-sym">)</span><span class="pas-space"> </span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">protected</span>
<span class="pas-space">    </span><span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">UpdateCritical</span><span class="pas-sym">(</span><span class="pas-ident">Value</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">Boolean</span><span class="pas-sym">)</span><span class="pas-space"> </span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-kwd">virtual</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">public</span>
<span class="pas-space">    </span><span class="pas-kwd">constructor</span><span class="pas-space"> </span><span class="pas-ident">Create</span><span class="pas-sym">;</span>
<span class="pas-space">    </span><span class="pas-kwd">property</span><span class="pas-space"> </span><span class="pas-ident">IsCritical</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">Boolean</span><span class="pas-space"> </span><span class="pas-kwd">read</span><span class="pas-space"> </span><span class="pas-ident">FIsCritical</span><span class="pas-space"> </span><span class="pas-kwd">write</span><span class="pas-space"> </span><span class="pas-ident">SetIsCritical</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-kwd">var</span>
<span class="pas-space">  </span><span class="pas-ident">SystemCritical</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">TSystemCritical</span><span class="pas-sym">;</span>

<span class="pas-kwd">implementation</span>

<span class="pas-comment">{ TSystemCritical }</span>
<span class="pas-comment">// REF: <a href="http://msdn.microsoft.com/en-us/library/aa373208.aspx" title="Off-site link" class="offsite">http://msdn.microsoft.com/en-us/library/aa373208.aspx</a></span>
<span class="pas-kwd">type</span>
<span class="pas-space">  </span><span class="pas-ident">EXECUTION_STATE</span><span class="pas-space"> </span><span class="pas-sym">=</span><span class="pas-space"> </span><span class="pas-ident">DWORD</span><span class="pas-sym">;</span>
<span class="pas-space">  </span>
<span class="pas-kwd">const</span>
<span class="pas-space">  </span><span class="pas-ident">ES_SYSTEM_REQUIRED</span><span class="pas-space"> </span><span class="pas-sym">=</span><span class="pas-space"> </span><span class="pas-hex">$00000001</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-ident">ES_DISPLAY_REQUIRED</span><span class="pas-space"> </span><span class="pas-sym">=</span><span class="pas-space"> </span><span class="pas-hex">$00000002</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-ident">ES_USER_PRESENT</span><span class="pas-space"> </span><span class="pas-sym">=</span><span class="pas-space"> </span><span class="pas-hex">$00000004</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-ident">ES_AWAYMODE_REQUIRED</span><span class="pas-space"> </span><span class="pas-sym">=</span><span class="pas-space"> </span><span class="pas-hex">$00000040</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-ident">ES_CONTINUOUS</span><span class="pas-space"> </span><span class="pas-sym">=</span><span class="pas-space"> </span><span class="pas-hex">$80000000</span><span class="pas-sym">;</span>
<span class="pas-space">  </span>
<span class="pas-space">  </span><span class="pas-ident">KernelDLL</span><span class="pas-space"> </span><span class="pas-sym">=</span><span class="pas-space"> </span><span class="pas-str">'kernel32.dll'</span><span class="pas-sym">;</span>

<span class="pas-comment">{</span>
<span class="pas-comment">  SetThreadExecutionState Function</span>
<span class="pas-comment">  Enables an application to inform the system that it is in use,</span>
<span class="pas-comment">  thereby preventing the system from entering sleep or turning off the</span>
<span class="pas-comment">  display while the application is running.</span>
<span class="pas-comment">}</span>
<span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">SetThreadExecutionState</span><span class="pas-sym">(</span><span class="pas-ident">ESFlags</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">EXECUTION_STATE</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-kwd">stdcall</span><span class="pas-sym">;</span><span class="pas-space"> </span><span class="pas-kwd">external</span><span class="pas-space"> </span><span class="pas-ident">kernel32</span><span class="pas-space"> </span><span class="pas-kwd">name</span><span class="pas-space"> </span><span class="pas-str">'SetThreadExecutionState'</span><span class="pas-sym">;</span>

<span class="pas-kwd">constructor</span><span class="pas-space"> </span><span class="pas-ident">TSystemCritical</span><span class="pas-sym">.</span><span class="pas-ident">Create</span><span class="pas-sym">;</span>
<span class="pas-kwd">begin</span>
<span class="pas-space">  </span><span class="pas-kwd">inherited</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-ident">FIsCritical</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space"> </span><span class="pas-ident">False</span><span class="pas-sym">;</span>
<span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">TSystemCritical</span><span class="pas-sym">.</span><span class="pas-ident">SetIsCritical</span><span class="pas-sym">(</span><span class="pas-kwd">const</span><span class="pas-space"> </span><span class="pas-ident">Value</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">Boolean</span><span class="pas-sym">)</span><span class="pas-space"> </span><span class="pas-sym">;</span>
<span class="pas-kwd">begin</span>
<span class="pas-space">  </span><span class="pas-kwd">if</span><span class="pas-space"> </span><span class="pas-ident">FIsCritical</span><span class="pas-space"> </span><span class="pas-sym">=</span><span class="pas-space"> </span><span class="pas-ident">Value</span><span class="pas-space"> </span><span class="pas-kwd">then</span>
<span class="pas-space">    </span><span class="pas-ident">Exit</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-ident">FIsCritical</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space"> </span><span class="pas-ident">Value</span><span class="pas-sym">;</span>
<span class="pas-space">  </span><span class="pas-ident">UpdateCritical</span><span class="pas-sym">(</span><span class="pas-ident">FIsCritical</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-kwd">procedure</span><span class="pas-space"> </span><span class="pas-ident">TSystemCritical</span><span class="pas-sym">.</span><span class="pas-ident">UpdateCritical</span><span class="pas-sym">(</span><span class="pas-ident">Value</span><span class="pas-sym">:</span><span class="pas-space"> </span><span class="pas-ident">Boolean</span><span class="pas-sym">)</span><span class="pas-space"> </span><span class="pas-sym">;</span>
<span class="pas-kwd">begin</span>
<span class="pas-space">  </span><span class="pas-kwd">if</span><span class="pas-space"> </span><span class="pas-ident">Value</span><span class="pas-space"> </span><span class="pas-kwd">then</span>
<span class="pas-space">    </span><span class="pas-comment">// Prevent the sleep idle time-out and Power off.</span>
<span class="pas-space">    </span><span class="pas-ident">SetThreadExecutionState</span><span class="pas-sym">(</span><span class="pas-ident">ES_SYSTEM_REQUIRED</span><span class="pas-space"> </span><span class="pas-kwd">or</span><span class="pas-space"> </span><span class="pas-ident">ES_CONTINUOUS</span><span class="pas-sym">)</span>
<span class="pas-space">  </span><span class="pas-kwd">else</span>
<span class="pas-space">    </span><span class="pas-comment">// Clear EXECUTION_STATE flags to disable away mode and allow the</span>
<span class="pas-space">    </span><span class="pas-comment">// system to idle to sleep normally.</span>
<span class="pas-space">    </span><span class="pas-ident">SetThreadExecutionState</span><span class="pas-sym">(</span><span class="pas-ident">ES_CONTINUOUS</span><span class="pas-sym">)</span><span class="pas-sym">;</span>
<span class="pas-kwd">end</span><span class="pas-sym">;</span>

<span class="pas-kwd">initialization</span>

<span class="pas-ident">SystemCritical</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space"> </span><span class="pas-ident">TSystemCritical</span><span class="pas-sym">.</span><span class="pas-ident">Create</span><span class="pas-sym">;</span>

<span class="pas-kwd">finalization</span>

<span class="pas-ident">SystemCritical</span><span class="pas-sym">.</span><span class="pas-ident">IsCritical</span><span class="pas-space"> </span><span class="pas-sym">:=</span><span class="pas-space"> </span><span class="pas-ident">False</span><span class="pas-sym">;</span>
<span class="pas-ident">SystemCritical</span><span class="pas-sym">.</span><span class="pas-ident">Free</span><span class="pas-sym">;</span>

<span class="pas-kwd">end</span><span class="pas-sym">.</span></pre>
</div>

<p>
  Here's one usage example:
</p>

<div class="frame">
<!-- Highlighted Pascal code generated by DelphiDabbler PasH -->
<pre class="pas-source"><span class="pas-ident">SystemCritical</span><span class="pas-sym">.</span><span class="pas-ident">IsCritical</span><span class="pas-space"> </span><span class="pas-sym">=</span><span class="pas-space"> </span><span class="pas-ident">true</span><span class="pas-sym">;</span>
<span class="pas-kwd">try</span>
<span class="pas-space">  </span><span class="pas-comment">// do critical operation here</span>
<span class="pas-space">  </span><span class="pas-comment">// without going in to sleep or turning off the display</span>
<span class="pas-kwd">finally</span>
<span class="pas-space">  </span><span class="pas-ident">SystemCritical</span><span class="pas-sym">.</span><span class="pas-ident">IsCritical</span><span class="pas-space"> </span><span class="pas-sym">=</span><span class="pas-space"> </span><span class="pas-ident">false</span><span class="pas-sym">;</span>
<span class="pas-kwd">end</span><span class="pas-sym">;</span></pre>
</div>

<table class="infotable">
  <tr>
    <th scope="row">Author:</th>
    <td>Shlomo Abuisak</td>
  </tr>
  <tr>
    <th scope="row">Contributor:</th>
    <td>Shlomo Abuisak</td>
  </tr>
  <tr>
    <th scope="row">Added:</th>
    <td>2009-11-05</td>
  </tr>
  <tr>
    <th scope="row">Last updated:</th>
    <td>
    2009-11-05</td>
  </tr>
</table>



<div id="footer">
  Copyright &copy; Peter Johnson (<a href="https://gravatar.com/delphidabbler">DelphiDabbler</a>) 2002-2020
</div> <!-- #footer -->
</div> <!-- #wrapper -->
</body>
</html>
