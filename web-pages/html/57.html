<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Inserting RTF code into a rich edit control</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
<meta http-equiv="Content-Language" content="en" />
<meta name="description" content="Inserting RTF code into a rich edit control" />
<meta name="keywords" content="programming, Delphi, hints, tips, hints and tips" />
<meta name="copyright" content="Copyright (c) 2002-2020 Peter D Johnson" />
<meta name="robots" content="INDEX,FOLLOW" />
<link rel="canonical" href="http://delphidabbler.com/tips/57" />
<link rel="stylesheet" href="/css/main.css" />
<link rel="stylesheet" href="/css/main-multicol-scr.css" media="screen" />
<link rel="stylesheet" href="/css/main-2col-scr.css" media="screen" />
<script type="text/javascript" src="/js/core.js"></script>
<script type="text/javascript" src="/js/offsite-win.js"></script>
<link rel="stylesheet" href="/css/tips.css" />
<script type="text/javascript" src="/js/popup-win.js"></script>
<script type="text/javascript" src="/js/show-hide.js"></script>
<link rel="alternate" href="/feeds/site-news-feed?id=tips" type="application/rss+xml" title="DelphiDabbler.com Tips News" />
<link rel="stylesheet" href="/css/source.css" />
<link rel="stylesheet" href="/css/js-detect.css" />
<script type="text/javascript" src="/js/js-detect.js"></script>
<script type="text/javascript">
  function showDemo(linkId, demoId) {
    showHide(linkId, demoId, 'Show demo code', 'Hide demo code');
  }
</script>
<!-- Begin Cookie Consent plugin by Silktide - http://silktide.com/cookieconsent -->
<script type="text/javascript">
    window.cookieconsent_options = {"message":"This site uses cookies to deliver its services, to enable targeted advertising and to support various social media buttons, and to analyse traffic. By using this site, you agree to its use of cookies.","dismiss":"Got it!","learnMore":"More info","link":"http://delphidabbler.com/subsid/cookies","theme":"dark-top"};
</script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/1.0.9/cookieconsent.min.js"></script>
<!-- End Cookie Consent plugin -->
</head>
<body>
<!-- Facebook script -->
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_GB/all.js#xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<div id="wrapper">
<div id="header">
<div class="hide-from-css">
<h1>DelphiDabbler.com</h1>
<p>Open source software, Delphi components, Tutorials &amp; more.</p>
</div> <!-- .hide-from-css -->
<div id="header-right">
<div id="quicklink" style="padding-right:4px;">
&raquo; <a href="/sitemap">Sitemap</a></div>
</div>
</div> <!-- #header -->
<div class="noprint" style="padding: 0 .5em .5em .5em; margin: .5em; background-color: #fcc;">
  <h2 class="smallcaps centre-align">
    &laquo;&laquo; Site Rescued &raquo;&raquo;
  </h2>
  <p class="highlight">
    While the site is still going to move from its current host, a new site will now take its place. <strong><a href="https://delphidabbler.blogspot.com/2020/03/delphidabblercom-is-no-longer-closing.html">More Info</a></strong>.
  </p>
  <p>
    The new site may have less content, but the core will now remain. And it will now play nicely with phones! Keep an eye on the <a href="https://delphidabbler.blogspot.com/">DelphiDabbler Blog</a> for news.
  </p>
</div>
<div id="navigation">
<hr class="hide-from-css" />
<h2 class="hide-from-css">Navigation</h2>
<ul>
<li><a href="/index">Home&nbsp;Page</a></li>
<li><a href="/programs">Programs</a></li>
<li><a href="/codelib">Delphi&nbsp;Library</a></li>
<li><a href="/snips-n-tips">Snippets&nbsp;&amp;&nbsp;Tips</a>
<ul>
<li class="sub-item"><a href="http://snippets.delphidabbler.com/" class="offsite-no-glyph">Code Snippets (Take 2)</a></li>
<li class="sub-item"><a href="/tips" class="selected ">Delphi&nbsp;Tips</a></li>
<li class="sub-item"><a href="http://swag.delphidabbler.com/" class="offsite-no-glyph">SWAG&nbsp;Archive</a></li>
</ul>
</li>
<li><a href="/articles">Articles</a></li>
<li><a href="http://wiki.delphidabbler.com/" class="offsite-no-glyph">Documentation</a></li>
<li><a href="/blog">Blog</a></li>
<li><a href="/news">News</a></li>
<li><a href="/contact">Contact</a></li>
<li><a href="/background">About</a></li>
</ul>
</div> <!-- #navigation -->
<div id="main">
<div id="content">
<span class="help noprint">&raquo <a href="/help/tips-help.html" class="js-popup">Help</a></span>
<h1>
	Inserting RTF code into a rich edit control
</h1>

<div class="noprint">
<!-- style in following div and non-breaking spaces are a work around for a
     rendering bug in IE7 that sometimes hides preceeding h1 section if nothing
     is printed before this show_ads.js code is run.
     Tested and runs OK on Safari, Opera, Firefox, Chrome, but then, so did the
     original code! -->
<div class="centre-align" style="font-size:1pt;">&nbsp;
<script type="text/javascript"><!--
google_ad_client = "ca-pub-0907703677935617";
/* 468x60, created 11/04/09 */
google_ad_slot = "8060165044";
google_ad_width = 468;
google_ad_height = 60;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
&nbsp;
</div>
</div>
<p>
  We all know how to load RTF code into a rich edit control. For example, if
  <var>RE</var> is a <var>TRichEdit</var> control, to load from a stream we'd
  use:
</p>

<div class="frame">
<!-- Highlighted Pascal code generated by DelphiDabbler PasH -->
<pre class="pas-source">RE.Lines.LoadFromStream(Stream);</pre>
</div>

<p>
  Or, if we're really careful:
</p>

<div class="frame">
<!-- Highlighted Pascal code generated by DelphiDabbler PasH -->
<pre class="pas-source">RE.PlainText := False;
RE.MaxLength := Stream.Size; <span class="pas-comment">// ensures long docs can display</span>
RE.Lines.LoadFromStream(Stream);</pre>
</div>

<p>
  That code overwrites the existing content. But what if we want to insert RTF
  code into some pre-existing code? Well, we need to hit the Windows API.
</p>

<p>
  We have to fill in a structure and set up some flags then pass them to the
  rich edit control via a message. We also need a call back function that
  Windows calls when it wants to read a chunk of data.
</p>

<p>
  The structure has three fields. The first takes a user-defined
  &quot;cookie&quot; that is passed to the callback function. The next field
  is an error code that the callback function passes back to the routine that
  sends the message. If this is non-zero the insertion should terminate. The
  final field is a reference to the callback function.
</p>

<p>
  I always think it's more flexible to read from streams rather than files, so
  the following example code shows how to insert RTF code from a stream:
</p>

<div class="frame">
<!-- Highlighted Pascal code generated by DelphiDabbler PasH -->
<pre class="pas-source"><span class="pas-kwd">procedure</span> RTFInsertStream(<span class="pas-kwd">const</span> RE: TRichEdit; <span class="pas-kwd">const</span> Stream: TStream);
<span class="pas-kwd">var</span>
  EditStream: TEditStream;  <span class="pas-comment">// callback used to read inserted RTF</span>
<span class="pas-kwd">begin</span>
  RE.Lines.BeginUpdate;
  <span class="pas-kwd">try</span>
    <span class="pas-comment">// Make sure rich edit is large enough to take inserted code</span>
    RE.MaxLength := RE.MaxLength + Stream.Size;
    <span class="pas-comment">// Stream in the RTF via EM_STREAMIN message</span>
    EditStream.dwCookie := DWORD(Stream);
    EditStream.dwError := <span class="pas-hex">$0000</span>;
    EditStream.pfnCallback := @EditStreamReader;
    RE.Perform(
      EM_STREAMIN,
      SFF_SELECTION <span class="pas-kwd">or</span> SF_RTF <span class="pas-kwd">or</span> SFF_PLAINRTF, LPARAM(@EditStream)
    );
    <span class="pas-comment">// Report any errors as a bug</span>
    <span class="pas-kwd">if</span> EditStream.dwError &lt;&gt; <span class="pas-hex">$0000</span> <span class="pas-kwd">then</span>
      <span class="pas-kwd">raise</span> Exception.Create(<span class="pas-str">'RTFInsertStream: Error inserting stream'</span>);
  <span class="pas-kwd">finally</span>
    RE.Lines.EndUpdate;
  <span class="pas-kwd">end</span>;
<span class="pas-kwd">end</span>;</pre>
</div>

<p>
  First we freeze the rich edit control then make sure it has sufficient
  capacity to receive the inserted code. Next we set up the structure:
</p>

<ul>
  <li>
    The <var>dwCookie</var> field receives a reference to the stream so that
    we can access it in the callback function.
  </li>
  <li>
    We initialise <var>dwError</var> to zero to indicate no error.
  </li>
  <li>
    <var>pfnCallback</var> is set to reference the function that Windows
    calls back to.
  </li>
</ul>

<p>
  Then we send the message. The flags mean that the insertion will
  replace any current selection (<var>SFF_SELECTION</var>), we're inserting
  RTF code rather than text (<var>SF_RTF</var>) and that only keywords common
  to all languages are used (<var>SFF_PLAINRTF</var>). After the message
  call returns we check that the <var>dwError</var> field is still 0 and raise
  an exception if not. If you don't want to overwrite selections leave out the
  <var>SFF_SELECTION</var> flag.
</p>

<p>
  All that remains is to define the callback function. Here it is:
</p>


<div class="frame">
<!-- Highlighted Pascal code generated by DelphiDabbler PasH -->
<pre class="pas-source"><span class="pas-kwd">function</span> EditStreamReader(dwCookie: DWORD; pBuff: Pointer;
  cb: LongInt; pcb: PLongInt): DWORD; <span class="pas-kwd">stdcall</span>;
<span class="pas-kwd">begin</span>
  Result := <span class="pas-hex">$0000</span>;  <span class="pas-comment">// assume no error</span>
  <span class="pas-kwd">try</span>
    pcb^ := TStream(dwCookie).Read(pBuff^, cb); <span class="pas-comment">// read data from stream</span>
  <span class="pas-kwd">except</span>
    Result := <span class="pas-hex">$FFFF</span>;  <span class="pas-comment">// indicates error to calling routine</span>
  <span class="pas-kwd">end</span>;
<span class="pas-kwd">end</span>;</pre>
</div>

<p>
  The <var>dwCookie</var> parameter contains the stream reference we prevously
  stored in the <var>TEditStream</var> structure. We cast this parameter to
  <var>TStream</var> and use it to read the stream. The <var>cb</var>
  parameter contains the number of bytes Windows wants us to provide so we
  attempt to read <var>cb</var> bytes from the stream into the buffer pointed
  to by the <var>pBuff</var> parameter. <var>pcb^</var> is set to the number
  of bytes actually read. We return zero on success or non-zero if there is an
  error. Windows passes this return value back to the caller via the
  <var>TEditStream.dwError</var> field.
</p>

<p>
  To make this code work you'll need the following <strong>uses</strong>
  clause:
</p>

<div class="frame">
<!-- Highlighted Pascal code generated by DelphiDabbler PasH -->
<pre class="pas-source"><span class="pas-kwd">uses</span>
  Windows, Classes, ComCtrls, RichEdit, SysUtils;</pre>
</div>

<h2>
  Adapting the code
</h2>

<p>
  If you prefer to read directly from a file, you could adapt
  <var>RTFInsertStream</var> to take a file name as a parameter, open the
  required file and store its handle in <var>TEditStream.dwCookie</var>. You
  would then read the file handle in the call back function. You would also
  want to change the name of <var>RTFInsertStream</var>!
</p>
<table class="infotable">
  <tr>
    <th scope="row">Author:</th>
    <td>Peter Johnson</td>
  </tr>
  <tr>
    <th scope="row">Contributor:</th>
    <td>Peter Johnson</td>
  </tr>
  <tr>
    <th scope="row">Added:</th>
    <td>2007-10-29</td>
  </tr>
  <tr>
    <th scope="row">Last updated:</th>
    <td>
    2007-10-29</td>
  </tr>
</table>

<div class="search noprint">
<form name="tipsSearchForm" id="tipsSearchForm" method="post" action="/tips">
<input class="text" type="text" name="txtSearch" id="txtSearch" value="" size="24" maxlength="80" />
<input class="button" type="submit" name="btnSearch" id="btnSearch" value="Search" />
</form>
</div>
<ul class="tip-nav noprint">
<li><a href="/tips/1">First</a></li>
<li><span class="spacer">...</span></li>
<li><a href="/tips/53">53</a></li>
<li><a href="/tips/54">54</a></li>
<li><a href="/tips/55">55</a></li>
<li><a href="/tips/56">56</a></li>
<li><span class="current">57</span></li>
<li><a href="/tips/58">58</a></li>
<li><a href="/tips/59">59</a></li>
<li><a href="/tips/60">60</a></li>
<li><a href="/tips/61">61</a></li>
<li><span class="spacer">...</span></li>
<li><a href="/tips/234">Last</a></li>
</ul>

<p class="centre-align noprint">
  &laquo; <a href="/tips">Return to contents</a> &raquo;
</p>

</div> <!-- #content -->
</div> <!-- #main -->
<div id="footer">
<div class="hide-from-css"><hr /></div> <!-- .hide-from-css -->
<a href="/copyright">Copyright</a> &copy; Peter Johnson (<a href="/background">DelphiDabbler</a>) 2002-2020</div> <!-- #footer -->
</div> <!-- #wrapper -->
</body>
</html>
